<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AS IF MEETING</title>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

    <style>
        :root {
            --bg-color: #fdfbf7;
            --accent-color: #d4a373;
            --text-main: #5d4037;
            --text-sub: #8d6e63;
            --card-glass: rgba(255, 255, 255, 0.9);
            --bubble-user: #eecbad;
            --bubble-pet: #ffffff;
        }

        body {
            background-color: var(--bg-color);
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: var(--text-main);
            font-family: 'STSong', 'SimSun', 'Playfair Display', serif;
            overflow: hidden;
        }

        /* ---------------- Step 1: å°é¢ ---------------- */
        #step1 {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            transition: opacity 0.8s ease;
            background: #d4cfc9;
        }

        .fullscreen-bg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: -1;
            filter: brightness(0.8) contrast(1.05);
            transition: opacity 1.5s ease, transform 20s ease-out;
            opacity: 0;
            transform: scale(1.1);
        }

        .fullscreen-bg.loaded {
            opacity: 1;
            transform: scale(1);
        }

        .cover-content {
            text-align: center;
            z-index: 2;
            padding: 40px;
            animation: floatUp 1.2s ease-out;
        }

        .app-title {
            font-size: 3.8rem;
            letter-spacing: 12px;
            margin-bottom: 15px;
            font-weight: 300;
            text-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            border-bottom: 1px solid rgba(255, 255, 255, 0.6);
            padding-bottom: 20px;
            display: inline-block;
        }

        .quote-text {
            font-size: 1.1rem;
            font-style: italic;
            margin-bottom: 50px;
            opacity: 0.95;
            letter-spacing: 2px;
            font-weight: 300;
            text-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            max-width: 800px;
            line-height: 1.6;
        }

        .mode-select {
            display: flex;
            gap: 25px;
            justify-content: center;
        }

        .mode-btn {
            padding: 15px 45px;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.6);
            color: white;
            font-size: 1rem;
            letter-spacing: 3px;
            cursor: pointer;
            transition: 0.3s;
            backdrop-filter: blur(10px);
            border-radius: 50px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .mode-btn:hover {
            background: white;
            color: #5d4037;
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .refresh-btn {
            margin-top: 40px;
            font-size: 0.8rem;
            opacity: 0.9;
            cursor: pointer;
            letter-spacing: 2px;
            transition: 0.3s;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }

        .refresh-btn:hover {
            transform: rotate(180deg);
        }

        /* åº•éƒ¨æ•°æ®ç»Ÿè®¡ */
        .stats-container {
            position: absolute;
            bottom: 30px;
            right: 40px;
            display: flex;
            gap: 20px;
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.6);
            font-family: sans-serif;
            letter-spacing: 1px;
            padding: 8px 10px;
            z-index: 3;
            opacity: 0;
            animation: fadeIn 2s ease-out 1s forwards;
            pointer-events: none;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 6px;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }

        .stat-num {
            font-weight: bold;
            color: #fff;
        }

        /* ---------------- Step 2: çµé­‚ç”»å»Š ---------------- */
        #step2-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: linear-gradient(to bottom, #fffcf5 0%, #f5efe6 100%);
            z-index: 800;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.8s ease;
        }

        #step2-container.active {
            display: flex;
            opacity: 1;
        }

        .gallery-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .gallery-title {
            font-size: 1.8rem;
            color: var(--text-main);
            letter-spacing: 8px;
            font-weight: normal;
            margin: 0;
        }

        .gallery-subtitle {
            font-size: 0.85rem;
            color: var(--text-sub);
            letter-spacing: 3px;
            margin-top: 10px;
            opacity: 0.6;
            font-family: sans-serif;
            text-transform: uppercase;
        }

        .soul-gallery {
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
            width: 95%;
            max-width: 1100px;
        }

        /* å¡ç‰‡æ ·å¼ */
        .soul-card {
            width: 170px;
            height: 260px;
            background: var(--card-glass);
            border: 1px solid #fff;
            border-radius: 16px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            backdrop-filter: blur(12px);
            box-shadow: 0 10px 25px rgba(139, 94, 60, 0.06);
        }

        .soul-visual {
            width: 70px;
            height: 70px;
            margin-bottom: 18px;
            border-radius: 50%;
            background: #fffbf0;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: 0.4s;
            border: 1px solid rgba(212, 163, 115, 0.15);
        }

        .soul-svg {
            width: 32px;
            height: 32px;
            fill: var(--accent-color);
            transition: 0.4s;
        }

        .soul-name {
            font-size: 1.05rem;
            color: var(--text-main);
            font-weight: bold;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        .soul-desc {
            font-size: 0.75rem;
            color: var(--text-sub);
            font-family: sans-serif;
            letter-spacing: 0.5px;
            text-align: center;
            padding: 0 12px;
            line-height: 1.5;
            opacity: 0.8;
        }

        .soul-card:hover {
            transform: translateY(-10px);
            background: white;
            box-shadow: 0 20px 40px rgba(212, 163, 115, 0.2);
        }

        .soul-card:hover .soul-visual {
            transform: scale(1.1);
            background: #fff0e0;
        }

        .soul-card:hover .soul-svg {
            fill: #8b5e3c;
        }

        .soul-card.selected {
            background: white;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px var(--accent-color) inset, 0 20px 40px rgba(212, 163, 115, 0.2);
        }

        /* --- è‡ªå®šä¹‰è¾“å…¥æ¡†ä¼˜åŒ– --- */
        .input-wrapper {
            height: 0;
            overflow: hidden;
            transition: height 0.4s ease;
            width: 100%;
            display: flex;
            justify-content: center;
        }

        .input-wrapper.show {
            height: 70px;
            margin-top: 25px;
        }

        .custom-inputs {
            background: white;
            padding: 10px 15px;
            border-radius: 50px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
            display: flex;
            gap: 10px;
            border: 1px solid #f0e6d2;
            align-items: center;
        }

        .custom-inputs input {
            border: none;
            outline: none;
            background: transparent;
            font-size: 0.9rem;
            color: #555;
            width: 90px;
            text-align: center;
            border-bottom: 1px solid #ddd;
            font-family: sans-serif;
            padding: 5px;
        }

        /* æ™ºèƒ½å¡«å……æŒ‰é’® */
        .magic-btn {
            background: linear-gradient(135deg, #e6b98d, #d4a373);
            color: white;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: 0.3s;
            box-shadow: 0 3px 8px rgba(212, 163, 115, 0.3);
            position: relative;
        }

        .magic-btn:hover {
            transform: scale(1.1) rotate(15deg);
        }

        .magic-btn::after {
            content: "AIæ„Ÿåº”";
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            background: #5d4037;
            color: #fff;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            opacity: 0;
            transition: 0.3s;
            pointer-events: none;
            white-space: nowrap;
        }

        .magic-btn:hover::after {
            opacity: 0.8;
            top: -35px;
        }

        .custom-hint {
            position: absolute;
            bottom: 85px;
            width: 100%;
            text-align: center;
            font-size: 0.75rem;
            color: #a88d83;
            opacity: 0;
            transition: opacity 0.5s;
            pointer-events: none;
        }

        .input-wrapper.show+.custom-hint {
            opacity: 0.8;
        }

        .confirm-btn {
            margin-top: 35px;
            padding: 12px 60px;
            border-radius: 50px;
            background: linear-gradient(135deg, #e6b98d, #d4a373);
            color: white;
            border: none;
            font-size: 1rem;
            letter-spacing: 4px;
            cursor: pointer;
            transition: 0.3s;
            box-shadow: 0 10px 20px rgba(212, 163, 115, 0.25);
        }

        .confirm-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 30px rgba(212, 163, 115, 0.35);
        }

        /* ---------------- Step 3: å¯¹è¯ ---------------- */
        #step3-container {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 900;
            align-items: center;
            justify-content: center;
            background: rgba(255, 252, 245, 0.5);
            backdrop-filter: blur(15px);
        }

        #step3-container.active {
            display: flex;
        }

        .chat-card {
            width: 90%;
            max-width: 550px;
            height: 85vh;
            background: #fff;
            border-radius: 16px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 30px 80px rgba(139, 94, 60, 0.1);
            overflow: hidden;
            animation: popIn 0.5s ease;
            border: 1px solid #f7f0e6;
        }

        .chat-header {
            padding: 18px;
            text-align: center;
            border-bottom: 1px solid #fbf8f3;
            background: #fffcf9;
            position: relative;
        }

        .chat-title {
            font-size: 1rem;
            color: var(--text-main);
            letter-spacing: 2px;
            font-weight: bold;
        }

        .chat-back {
            position: absolute;
            right: 20px;
            top: 20px;
            cursor: pointer;
            color: #ccc;
            transition: 0.3s;
        }

        .chat-back:hover {
            color: var(--accent-color);
        }

        #displayArea {
            flex: 1;
            overflow-y: auto;
            padding: 30px;
            background: #fffcf9;
            display: flex;
            flex-direction: column;
        }

        .diary-paper {
            background: #fff;
            padding: 45px 35px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.03);
            margin: 15px auto;
            width: 85%;
            border: 1px solid #f2eada;
            border-radius: 4px;
            position: relative;
        }

        .diary-paper::before {
            content: "â€œ";
            position: absolute;
            top: 10px;
            left: 20px;
            font-size: 40px;
            color: #f0e6d2;
            font-family: serif;
        }

        .diary-content {
            font-family: 'Kaiti', serif;
            line-height: 2.2;
            font-size: 1.1rem;
            color: #4a3b32;
            text-align: justify;
        }

        .chat-bubble {
            max-width: 78%;
            padding: 15px 20px;
            margin-bottom: 20px;
            font-size: 15px;
            line-height: 1.7;
            border-radius: 12px;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.02);
        }

        .bubble-user {
            align-self: flex-end;
            background: var(--bubble-user);
            color: #5d4037;
            border-bottom-right-radius: 2px;
        }

        .bubble-pet {
            align-self: flex-start;
            background: #fff;
            border: 1px solid #f0e6d2;
            color: #6b5a50;
            border-bottom-left-radius: 2px;
        }

        .input-panel {
            padding: 20px 30px;
            background: #fff;
            border-top: 1px solid #fbf8f3;
            display: flex;
            gap: 15px;
            align-items: center;
        }

        textarea {
            flex: 1;
            border: 1px solid #eee;
            padding: 12px 15px;
            height: 40px;
            resize: none;
            outline: none;
            border-radius: 20px;
            background: #fcfbf9;
            font-family: sans-serif;
            transition: 0.3s;
            font-size: 0.95rem;
            color: #666;
        }

        textarea:focus {
            background: white;
            border-color: var(--accent-color);
        }

        #sendBtn {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            background: var(--accent-color);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: 0.3s;
        }

        #sendBtn:hover {
            transform: scale(1.1);
            background: #c59265;
        }

        /* çŠ¶æ€åŠ è½½æ ·å¼ */
        #loading {
            font-family: sans-serif;
            letter-spacing: 1px;
            display: none;
            text-align: center;
            padding: 12px;
            color: #d4a373;
            font-size: 12px;
            opacity: 0.8;
            animation: breathe 2s infinite ease-in-out;
        }

        @keyframes breathe {

            0%,
            100% {
                opacity: 0.6;
            }

            50% {
                opacity: 1;
            }
        }

        @keyframes floatUp {
            from {
                opacity: 0;
                transform: translateY(40px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes popIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }
    </style>
</head>

<body>

    <div id="step1">
        <img id="bgImg" class="fullscreen-bg" src="" alt="" onerror="handleImgError(this)">
        <div class="cover-content">
            <h1 class="app-title">AS IF MEETING</h1>
            <div id="quoteBox">
                <div class="quote-text">ã€Œ æ­£åœ¨è¿æ¥æ—¶ç©º... ã€</div>
            </div>
            <div class="mode-select">
                <button class="mode-btn" onclick="startApp('chat')">å³æ—¶å¯¹è°ˆ</button>
                <button class="mode-btn" onclick="startApp('diary')">å²æœˆç•™ç—•</button>
            </div>
            <div class="refresh-btn" onclick="refreshCover()">â†» åˆ‡æ¢é£æ™¯</div>
        </div>

        <div class="stats-container">
            <div class="stat-item">
                <span>æ—¶ç©ºè½¨è¿¹</span>
                <span class="stat-num" id="busuanzi_value_site_pv">...</span>
            </div>
            <div style="width:1px; height:12px; background:rgba(255,255,255,0.4);"></div>
            <div class="stat-item">
                <span>å…±é¸£çµé­‚</span>
                <span class="stat-num" id="busuanzi_value_site_uv">...</span>
            </div>
        </div>
    </div>

    <div id="step2-container">
        <div class="gallery-header">
            <h2 class="gallery-title">é€‰æ‹©çµé­‚è¿ç»“</h2>
            <div class="gallery-subtitle">An Encounter in the Void</div>
        </div>

        <div class="soul-gallery" id="galleryContainer">
        </div>

        <div class="input-wrapper" id="customInputWrapper">
            <div class="custom-inputs">
                <input type="text" id="customName" placeholder="åå­—"
                    onkeydown="if(event.keyCode===13) autoFillProfile()">
                <button class="magic-btn" onclick="autoFillProfile()">âœ¨</button>
                <input type="text" id="customType" placeholder="èº«ä»½ (é€‰å¡«)">
                <input type="text" id="customTags" placeholder="æ€§æ ¼">
            </div>
        </div>
        <div class="custom-hint" id="hintText"
            style="display:none; margin-top:10px; font-size:0.8rem; color:#999; text-align:center;">
            ğŸ’¡ æç¤ºï¼šè¾“å…¥åå­—åç‚¹å‡»âœ¨ï¼Œå¯è‡ªåŠ¨æ„Ÿåº”è¡¥å…¨â€ã€‚
        </div>

        <button class="confirm-btn" onclick="toStep(3)">å¼€å¯è¿ç»“</button>
    </div>

    <div id="step3-container">
        <div class="chat-card">
            <div class="chat-header">
                <span id="navInfo" class="chat-title">...</span>
                <span class="chat-back" onclick="location.reload()">â†º</span>
            </div>
            <div id="displayArea"></div>
            <div id="loading">...</div>
            <div class="input-panel">
                <textarea id="mainInput" placeholder="å†™ä¸‹æ­¤åˆ»çš„æƒ³æ³•..."></textarea>
                <button id="sendBtn" onclick="handleAction()">â¤</button>
            </div>
            <div style="text-align: center; padding: 8px; background: #fff; font-size: 10px;">
                <span onclick="saveImg()" style="cursor:pointer; color:#bcaaa4;">ä¿å­˜å®Œæ•´ç”»å·</span>
            </div>
        </div>
    </div>

    <script>
        const API_KEY = 'sk-32bee463dc41420e95b8b2dd40ec71b5';
        let config = { mode: '', pet: {} };
        let history = [];

        /* ================= æ•°æ®å±‚ ================= */
        const wallpaperIds = [
            "1490730141103-6c8f7db0e308", "1507525428034-b723cf961d3e",
            "1519681393784-d120267933ba", "1470252649378-9c29740c9fa8",
            "1494438639946-1ebd1d20bf85", "1477346611705-65d1883cee1e",
            "1454165804606-c3d57bc86b40", "1518173946633-4c6662413a7d",
            "1489549132488-d00b7eee80f1", "1532274402911-5a369e4c4bb5"
        ];
        const BACKUP_IMG = "https://picsum.photos/1920/1080?blur=2";

        const icons = {
            cat: "M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-5-9c.83 0 1.5-.67 1.5-1.5S7.83 8 7 8s-1.5.67-1.5 1.5S6.17 11 7 11zm10 0c.83 0 1.5-.67 1.5-1.5S17.83 8 17 8s-1.5.67-1.5 1.5.67 1.5 1.5 1.5z",
            dog: "M12,2C6.48,2,2,6.48,2,12s4.48,10,10,10s10-4.48,10-10S17.52,2,12,2z M7,10.5c0-0.83,0.67-1.5,1.5-1.5s1.5,0.67,1.5,1.5S9.33,12,8.5,12S7,11.33,7,10.5z M12.5,16c-1.83,0-3.44-0.82-4.5-2.09l0.92-1.19c0.79,0.92,1.96,1.51,3.29,1.53c1.33-0.02,2.5-0.61,3.29-1.53l0.92,1.19C15.44,15.18,14.04,16,12.5,16z M16.5,12c-0.83,0-1.5-0.67-1.5-1.5S15.67,9,16.5,9s1.5,0.67,1.5,1.5S17.33,12,16.5,12z",
            clock: "M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z",
            pen: "M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z",
            heart: "M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z",
            star: "M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z",
            magic: "M7.5 5.6L10 7 8.6 4.5 10 2 7.5 3.4 5 2l1.4 2.5L5 7zm12 9.8L17 14l1.4 2.5L21 14l-2.5 1.4L17 17l2.5 1.4L21 21l-1.5-2.6zM19 2l-1.4 2.5L15 2l2.5 1.4L19 7l1.4-2.5L23 2l-2.5-2.6z",
            add: "M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"
        };

        const malePool = [
            { name: "æç™½", type: "è¯—ä»™", tags: "è±ªæ”¾ã€æµªæ¼«ã€é†‰é…’", desc: "ä¸¾æ¯é‚€æœˆ", icon: icons.pen, states: ["æ­£åœ¨æ–Ÿé…Œè¾è—»...", "æ­£åœ¨å‡è§†æœˆå…‰...", "æ­£åœ¨æ„æ€ç»å¥..."] },
            { name: "ç‹å°”å¾·", type: "ä½œå®¶", tags: "æ¯’èˆŒã€å”¯ç¾ã€é«˜å‚²", desc: "å”¯ç¾ä¸»ä¹‰", icon: icons.pen, states: ["æ­£åœ¨æ€è€ƒæ‚–è®º...", "æ­£åœ¨å®¡è§†ç¾å­¦...", "æ­£åœ¨æ„æ€é‡‘å¥..."] },
            { name: "æ‘ä¸Šæ˜¥æ ‘", type: "å°è¯´å®¶", tags: "ç–ç¦»ã€çˆµå£«ã€è·‘æ­¥", desc: "ä¸”å¬é£åŸ", icon: icons.pen, states: ["æ­£åœ¨å¯»æ‰¾éšå–»...", "æ­£åœ¨è†å¬é£å£°...", "æ­£åœ¨æ€è€ƒå°½å¤´..."] },
            { name: "é™†æ²‰", type: "æ¸©æŸ”å­¦é•¿", tags: "ç»†å¿ƒã€æ¸©æ¶¦å¦‚ç‰ã€æš—æ‹", desc: "å€Ÿä½ çš„ç¬”è®°", icon: icons.heart, states: ["æ­£åœ¨æƒ³å¿µä½ ...", "æ­£åœ¨æ•´ç†æ€ç»ª...", "æ­£åœ¨ç¿»çœ‹åˆç…§..."] },
            { name: "å¶ä¿®", type: "ç”µç«å¤§ç¥", tags: "æ…µæ‡’ã€å˜²è®½ã€è£è€€", desc: "å†ç©åå¹´", icon: icons.star, states: ["æ­£åœ¨å¤ç›˜æˆ˜å±€...", "æ­£åœ¨æ€è€ƒæˆ˜æœ¯...", "æ­£åœ¨é—­ç›®å…»ç¥..."] },
            { name: "Dracula", type: "å¸è¡€é¬¼å…¬çˆµ", tags: "ä¼˜é›…ã€å±é™©ã€æ°¸ç”Ÿ", desc: "æš®å…‰ä¹‹åŸ", icon: icons.magic, states: ["æ­£åœ¨å›å¿†æ°¸æ’...", "æ­£åœ¨å‡è§†è™šç©º...", "æ­£åœ¨æ„Ÿåº”ä½ çš„æ°”æ¯..."] },
            { name: "ç¦å°”æ‘©æ–¯", type: "ä¾¦æ¢", tags: "é«˜æ™ºå•†ã€å‚²å¨‡ã€é€»è¾‘", desc: "åŸºæœ¬æ¼”ç»", icon: icons.pen, states: ["æ­£åœ¨è¿›å…¥æ€ç»´æ®¿å ‚...", "æ­£åœ¨æ¼”ç»æ¨ç†...", "æ­£åœ¨è¿æ¥çº¿ç´¢..."] }
        ];

        const femalePool = [
            { name: "å¼ çˆ±ç²", type: "ä½œå®¶", tags: "å†·çœ¼ã€è‹å‡‰ã€é€šé€", desc: "çº¢å°˜å¾€äº‹", icon: icons.pen, states: ["æ­£åœ¨å†·çœ¼æ—è§‚...", "æ­£åœ¨ç»†ç»†ç«¯è¯¦...", "æ­£åœ¨å›å‘³è‹å‡‰..."] },
            { name: "ææ¸…ç…§", type: "è¯äºº", tags: "å©‰çº¦ã€æ‰æƒ…ã€æ„ç»ª", desc: "å¯»å¯»è§…è§…", icon: icons.pen, states: ["æ­£åœ¨æ²‰åŸ...", "æ­£åœ¨æ€ç´¢ä½³å¥...", "æ­£åœ¨æ„Ÿæ€€èº«ä¸–..."] },
            { name: "æ—å¾½å› ", type: "å»ºç­‘å¸ˆ", tags: "æ‰å¥³ã€ç†æ€§ã€è¯—æ„", desc: "äººé—´å››æœˆå¤©", icon: icons.pen, states: ["æ­£åœ¨æ„æ€è“å›¾...", "æ­£åœ¨å¯»æ‰¾çµæ„Ÿ...", "æ­£åœ¨é™å¿ƒæ€è€ƒ..."] },
            { name: "ç‘¶", type: "é¹¿çµå°‘å¥³", tags: "å‚²å¨‡ã€é™„èº«ã€æ£è›‹", desc: "ä¸ºä½ ç—›ç—›é£èµ°", icon: icons.magic, states: ["æ­£åœ¨æ„Ÿåº”è‡ªç„¶...", "æ­£åœ¨å‘å‘†...", "æ­£åœ¨åšç™½æ—¥æ¢¦..."] },
            { name: "ç»˜æ¢¨è¡£", type: "çº¢å‘å·«å¥³", tags: "å•çº¯ã€å¼ºå¤§ã€ä¾æ‹", desc: "ä¸–ç•Œå¾ˆç¾", icon: icons.magic, states: ["æ­£åœ¨è§‚å¯Ÿä¸–ç•Œ...", "æ­£åœ¨å†™å°æœ¬æœ¬...", "æ­£åœ¨å‘å‘†..."] }
        ];

        /* ================= é€»è¾‘å±‚ ================= */

        // 1. ä¿®å¤ï¼šDOMContentLoaded ç«‹å³æ‰§è¡Œæœ¬åœ°é€»è¾‘
        document.addEventListener('DOMContentLoaded', () => {
            try {
                generateLocalSouls();
            } catch (e) {
                console.error("ç”Ÿæˆå¤±è´¥", e);
                document.getElementById('galleryContainer').innerHTML = 'åŠ è½½ä¸­...';
            }
            refreshCover();
        });

        async function refreshCover() {
            const bgImg = document.getElementById('bgImg');
            const quoteBox = document.getElementById('quoteBox');
            const randomId = wallpaperIds[Math.floor(Math.random() * wallpaperIds.length)];
            const imgUrl = `https://images.unsplash.com/photo-${randomId}?auto=format&fit=crop&w=1920&q=80`;

            const newImg = new Image();
            newImg.src = imgUrl;
            newImg.onload = () => { if (bgImg) { bgImg.src = imgUrl; bgImg.classList.add('loaded'); } };
            newImg.onerror = () => { if (bgImg) { bgImg.src = BACKUP_IMG; bgImg.classList.add('loaded'); } };

            try {
                const response = await fetch('https://v1.hitokoto.cn/?c=d&c=i&c=k');
                const data = await response.json();
                if (quoteBox) quoteBox.innerHTML = `<div class="quote-text">ã€Œ ${data.hitokoto} ã€</div>`;
            } catch (e) {
                const quotes = ["ä¸‡ç‰©çš†æœ‰è£‚ç—•ï¼Œé‚£æ˜¯å…‰ç…§è¿›æ¥çš„åœ°æ–¹ã€‚", "å¤©é’è‰²ç­‰çƒŸé›¨ï¼Œè€Œæˆ‘åœ¨ç­‰ä½ ã€‚", "ä½ è¢«å†™åœ¨æˆ‘çš„æ­Œé‡Œã€‚"];
                if (quoteBox) quoteBox.innerHTML = `<div class="quote-text">ã€Œ ${quotes[Math.floor(Math.random() * quotes.length)]} ã€</div>`;
            }
        }

        function handleImgError(img) { img.src = BACKUP_IMG; img.classList.add('loaded'); }

        function startApp(mode) {
            config.mode = mode;
            const step1 = document.getElementById('step1');
            const step2 = document.getElementById('step2-container');

            // ç¡®ä¿å†…å®¹å­˜åœ¨
            if (document.getElementById('galleryContainer').children.length === 0) {
                generateLocalSouls();
            }

            step1.style.opacity = '0';
            step1.style.pointerEvents = 'none';
            setTimeout(() => {
                step1.style.display = 'none';
                step2.style.display = 'flex';
                setTimeout(() => step2.classList.add('active'), 50);
            }, 600);
        }

        function generateLocalSouls() {
            const container = document.getElementById('galleryContainer');
            if (!container) return;
            container.innerHTML = '';

            const fixed = [
                { name: "æ©˜çŒ«Â·æš–æš–", type: "æ©˜çŒ«", tags: "æ²»æ„ˆã€è´ªåƒã€å‚²å¨‡", desc: "äººé—´çƒŸç«", icon: icons.cat, states: ["æ­£åœ¨æ€è€ƒçŒ«ç”Ÿ...", "æ­£åœ¨æ„Ÿåº”ä½ çš„æƒ…ç»ª...", "æ­£åœ¨æœ›ç€çª—å¤–å‘å‘†..."] },
                { name: "é‡‘æ¯›Â·å·´é¡¿", type: "é‡‘æ¯›", tags: "å¿ è¯šã€é˜³å…‰ã€å¤§æš–ç”·", desc: "æ°¸è¿œå®ˆæŠ¤ä½ ", icon: icons.dog, states: ["æ­£åœ¨æ—¶åˆ»å‡†å¤‡ç€...", "æ­£åœ¨å®ˆæŠ¤ä½ çš„æ¢¦...", "æ­£åœ¨æ­ªå¤´æ€è€ƒ..."] }
            ];

            const safeMale = malePool && malePool.length > 0 ? malePool[Math.floor(Math.random() * malePool.length)] : fixed[0];
            const safeFemale = femalePool && femalePool.length > 0 ? femalePool[Math.floor(Math.random() * femalePool.length)] : fixed[0];
            const list = [...fixed, safeMale, safeFemale];

            list.forEach(char => {
                const card = document.createElement('div');
                card.className = 'soul-card';
                card.onclick = () => setPet(char);
                card.innerHTML = `
                    <div class="soul-visual"><svg class="soul-svg" viewBox="0 0 24 24"><path d="${char.icon}"/></svg></div>
                    <span class="soul-name">${char.name}</span>
                    <span class="soul-desc">${char.desc}</span>
                `;
                container.appendChild(card);
            });

            const customCard = document.createElement('div');
            customCard.className = 'soul-card';
            customCard.style.borderStyle = 'dashed';
            customCard.style.background = 'rgba(255,255,255,0.4)';
            customCard.onclick = () => showCustom(customCard);
            customCard.innerHTML = `
                <div class="soul-visual" style="background:transparent; border:1px solid #d4a373"><svg class="soul-svg" viewBox="0 0 24 24"><path d="${icons.add}"/></svg></div>
                <span class="soul-name">è‡ªå®šä¹‰</span>
                <span class="soul-desc">åˆ›é€ ç‹¬ä¸€æ— äºŒ</span>
            `;
            container.appendChild(customCard);
        }

        function setPet(char) {
            config.pet = char;
            document.querySelectorAll('.soul-card').forEach(c => c.classList.remove('selected'));
            event.currentTarget.classList.add('selected');
            document.getElementById('customInputWrapper').classList.remove('show');
            document.getElementById('hintText').style.display = 'none';
        }

        function showCustom(el) {
            document.querySelectorAll('.soul-card').forEach(c => c.classList.remove('selected'));
            el.classList.add('selected');
            document.getElementById('customInputWrapper').classList.add('show');
            document.getElementById('hintText').style.display = 'block';
            config.pet = {};
        }

        // --- æ ¸å¿ƒæ›´æ–°ï¼šåŒå±‚æœç´¢é€»è¾‘ ---
        async function autoFillProfile() {
            const nameInput = document.getElementById('customName');
            const typeInput = document.getElementById('customType');
            const tagsInput = document.getElementById('customTags');

            const name = nameInput.value.trim();
            const currentType = typeInput.value.trim(); // è·å–å½“å‰ç”¨æˆ·æ˜¯å¦å·²ç»è¾“å…¥äº†èº«ä»½

            if (!name) return alert("è¯·å…ˆè¾“å…¥åå­—~");

            // æŒ‰é’®åŠ¨æ•ˆ
            const btn = document.querySelector('.magic-btn');
            const originalText = btn.innerHTML;
            btn.innerHTML = "âŒ›";
            btn.style.pointerEvents = "none";

            let prompt = "";

            if (currentType) {
                // ã€ç¬¬äºŒå±‚ã€‘: åå­— + èº«ä»½ -> ç”Ÿæˆæ€§æ ¼
                prompt = `ç”¨æˆ·è®¾å®šäº†ä¸€ä¸ªè§’è‰²ï¼šåå­—æ˜¯â€œ${name}â€ï¼Œèº«ä»½æ˜¯â€œ${currentType}â€ã€‚
                è¯·æ ¹æ®è¿™ä¸ªç‰¹å®šç»„åˆï¼Œç”Ÿæˆ3ä¸ªæ€§æ ¼æ ‡ç­¾ï¼ˆtagsï¼‰ã€‚
                ä¾‹å¦‚ï¼šè‹¥åå­—æ˜¯æ—é»›ç‰ï¼Œèº«ä»½æ˜¯æ‹³å‡»æ‰‹ï¼Œæ€§æ ¼æ ‡ç­¾åº”ä½“ç°åå·®ï¼ˆå¦‚ï¼šå€’æ‹”å‚æ¨æŸ³ã€å¿§éƒé‡æ‹³ã€æš´åŠ›ç¾å­¦ï¼‰ã€‚
                è¯·ä»…è¿”å› JSON æ ¼å¼ï¼š{"type": "${currentType}", "tags": "ä¸‰ä¸ªæ€§æ ¼å…³é”®è¯,é€—å·éš”å¼€"}`;
            } else {
                // ã€ç¬¬ä¸€å±‚ã€‘: åªæœ‰åå­— -> ç”Ÿæˆèº«ä»½ + æ€§æ ¼
                prompt = `è¯·æ£€ç´¢å…³äºäººç‰©â€œ${name}â€çš„ä¿¡æ¯ã€‚
                1. å¦‚æœæ˜¯å·²çŸ¥äººç‰©ï¼Œæä¾›å…¶ã€æœ€ç»å…¸èº«ä»½ã€‘ï¼ˆ4å­—å†…ï¼‰å’Œã€æ ¸å¿ƒæ€§æ ¼å…³é”®è¯ã€‘ï¼ˆ3ä¸ªï¼‰ã€‚
                2. å¦‚æœæ˜¯é™Œç”Ÿåå­—ï¼Œéšæœºç”Ÿæˆä¸€ä¸ªå”¯ç¾çš„å¤é£æˆ–ç°ä»£äººè®¾ã€‚
                3. è¯·ä»…è¿”å› JSON æ ¼å¼ï¼š{"type": "èº«ä»½", "tags": "æ€§æ ¼æ ‡ç­¾"}`;
            }

            try {
                const res = await fetch("https://api.deepseek.com/chat/completions", {
                    method: "POST", headers: { "Content-Type": "application/json", "Authorization": `Bearer ${API_KEY}` },
                    body: JSON.stringify({
                        model: "deepseek-chat",
                        messages: [{ role: "user", content: prompt }]
                    })
                });
                const data = await res.json();
                let content = data.choices[0].message.content;
                content = content.replace(/```json|```/g, '').trim();
                const result = JSON.parse(content);

                // å¦‚æœæ˜¯ç¬¬ä¸€å±‚ï¼Œä¼šåŒæ—¶å¡«å…¥ type å’Œ tags
                // å¦‚æœæ˜¯ç¬¬äºŒå±‚ï¼ŒAPIè¿”å›çš„ type å°±æ˜¯ç”¨æˆ·å¡«çš„ï¼Œä¸»è¦æ›´æ–° tags
                typeInput.value = result.type;
                tagsInput.value = result.tags;

            } catch (e) {
                console.error(e);
                alert("æ„Ÿåº”å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨è¾“å…¥è¯•è¯•~");
            } finally {
                btn.innerHTML = originalText;
                btn.style.pointerEvents = "auto";
            }
        }

        function toStep(n) {
            if (n === 3) {
                const customName = document.getElementById('customName').value;
                if (!config.pet.name && customName) {
                    config.pet = {
                        name: customName,
                        type: document.getElementById('customType').value || 'æœªçŸ¥çµé­‚',
                        tags: document.getElementById('customTags').value || 'ç¥ç§˜',
                        states: ["æ­£åœ¨å‡è§†...", "æ­£åœ¨æ€è€ƒ...", "æ­£åœ¨å¾®ç¬‘..."]
                    };
                }
                if (!config.pet.name) return alert("è¯·é€‰æ‹©ä¸€ä½çµé­‚ä¼´ä¾£");

                const step2 = document.getElementById('step2-container');
                step2.style.opacity = 0;
                setTimeout(() => {
                    step2.style.display = 'none';
                    document.getElementById('step3-container').classList.add('active');
                    initStep3();
                }, 600);
            }
        }

        function getRandomState(char) {
            if (!char.states || char.states.length === 0) return "æ­£åœ¨æ€è€ƒ...";
            return char.states[Math.floor(Math.random() * char.states.length)];
        }

        async function initStep3() {
            document.getElementById('navInfo').innerText = `${config.pet.name}`;
            const loading = document.getElementById('loading');
            loading.innerText = getRandomState(config.pet);
            loading.style.display = 'block';

            const systemPrompt = `ä½ ç°åœ¨å¿…é¡»å®Œå…¨æ‰®æ¼”ã€${config.pet.name}ã€‘ã€‚
            èº«ä»½ï¼š${config.pet.type}ã€‚æ€§æ ¼ï¼š${config.pet.tags}ã€‚
            
            ã€é‡è¦æŒ‡ä»¤ã€‘ï¼š
            1. è¯·åŠ¡å¿…åŸºäºç”¨æˆ·è®¾å®šçš„èº«ä»½ï¼ˆ${config.pet.type}ï¼‰å’Œæ€§æ ¼ï¼ˆ${config.pet.tags}ï¼‰è¿›è¡Œå¯¹è¯ã€‚
            2. å¦‚æœè®¾å®šæœ‰åå·®ï¼ˆå¦‚æ—é»›ç‰æ˜¯æ‹³å‡»æ‰‹ï¼‰ï¼Œè¯·åŠ¡å¿…ä½“ç°è¿™ç§åå·®èŒã€‚
            3. ä¸¥ç¦è¯´è‡ªå·±æ˜¯AIã€‚
            4. åªæœ‰ç¬¬ä¸€å¥è¯ï¼šå­—æ•°30å­—ä»¥å†…ï¼Œæå…·ä»£å…¥æ„Ÿã€‚`;

            try {
                const res = await fetch("https://api.deepseek.com/chat/completions", {
                    method: "POST", headers: { "Content-Type": "application/json", "Authorization": `Bearer ${API_KEY}` },
                    body: JSON.stringify({
                        model: "deepseek-chat",
                        messages: [{ role: "system", content: systemPrompt }, { role: "user", content: "ï¼ˆå»ºç«‹è¿ç»“ï¼‰" }]
                    })
                });
                const data = await res.json();
                addPetBubble(data.choices[0].message.content);
            } catch (e) { addPetBubble("ï¼ˆæ˜Ÿå…‰é—ªçƒï¼‰è¿ç»“å·²å»ºç«‹ã€‚"); }
            finally { loading.style.display = 'none'; }
        }

        async function handleAction() {
            const input = document.getElementById('mainInput');
            const text = input.value.trim();
            if (!text) return;

            if (config.mode === 'chat') addUserBubble(text);
            input.value = '';

            const loading = document.getElementById('loading');
            loading.innerText = getRandomState(config.pet);
            loading.style.display = 'block';

            const systemPrompt = config.mode === 'chat'
                ? `ä½ å®Œå…¨æ²‰æµ¸åœ¨${config.pet.name}ï¼ˆ${config.pet.type}ï¼‰çš„è§’è‰²ä¸­ã€‚æ€§æ ¼ï¼š${config.pet.tags}ã€‚è¯·ä¸¥æ ¼ä¿æŒè¯¥äººè®¾ã€‚`
                : `ä½ æ˜¯ä¸€ä¸ª${config.pet.type}ï¼ˆ${config.pet.name}ï¼‰ã€‚è¯·å°†ç”¨æˆ·çš„è¿™æ®µè¯æ”¹å†™ä¸ºä¸€ç¯‡ç¬¬ä¸€äººç§°çš„æ—¥è®°ã€‚`;

            try {
                const res = await fetch("https://api.deepseek.com/chat/completions", {
                    method: "POST", headers: { "Content-Type": "application/json", "Authorization": `Bearer ${API_KEY}` },
                    body: JSON.stringify({
                        model: "deepseek-chat",
                        messages: [{ role: "system", content: systemPrompt }, ...history, { role: "user", content: text }]
                    })
                });
                const data = await res.json();
                const reply = data.choices[0].message.content;

                if (config.mode === 'chat') {
                    history.push({ role: "user", content: text }, { role: "assistant", content: reply });
                    addPetBubble(reply);
                } else {
                    renderDiary(reply);
                }
            } catch (e) { addPetBubble("ä¿¡å·åœ¨æ˜Ÿç©ºä¸­è¿·å¤±äº†..."); }
            finally { loading.style.display = 'none'; }
        }

        function addUserBubble(t) { const d = document.createElement('div'); d.className = 'chat-bubble bubble-user'; d.innerText = t; document.getElementById('displayArea').appendChild(d); scroll(); }
        function addPetBubble(t) { const d = document.createElement('div'); d.className = 'chat-bubble bubble-pet'; d.innerText = t; document.getElementById('displayArea').appendChild(d); scroll(); }
        function renderDiary(t) { const area = document.getElementById('displayArea'); area.innerHTML = ''; const note = document.createElement('div'); note.className = 'diary-paper'; note.innerHTML = `<div class="diary-content">${t}</div>`; area.appendChild(note); }
        function scroll() { const d = document.getElementById('displayArea'); d.scrollTop = d.scrollHeight; }

        // --- ä¿®å¤ç‰ˆï¼šé•¿æˆªå›¾ä¿å­˜ ---
        function saveImg() {
            const originalTarget = config.mode === 'diary' ? document.querySelector('.diary-paper') : document.getElementById('displayArea');

            // å…‹éš†èŠ‚ç‚¹
            const clone = originalTarget.cloneNode(true);

            // è®¾ç½®æ ·å¼ï¼Œç§»å‡ºè§†å£ä½†ä¿æŒæ¸²æŸ“
            clone.style.position = 'absolute';
            clone.style.top = '-10000px';
            clone.style.left = '0';
            clone.style.width = originalTarget.offsetWidth + 'px'; // ä¿æŒåŸå®½
            clone.style.height = 'auto'; // é«˜åº¦è‡ªé€‚åº”
            clone.style.overflow = 'visible'; // å…è®¸æº¢å‡º
            clone.style.background = '#fffcf9'; // ç¡®ä¿èƒŒæ™¯è‰²
            clone.style.zIndex = '-1';

            if (config.mode === 'chat') {
                clone.style.padding = '30px';
                clone.style.display = 'block';
            }

            document.body.appendChild(clone);

            html2canvas(clone, {
                backgroundColor: "#fffcf9",
                scale: 2,
                useCORS: true,
                height: clone.scrollHeight // å¼ºåˆ¶æˆªå–å®Œæ•´é«˜åº¦
            }).then(canvas => {
                const a = document.createElement('a');
                a.download = `${config.pet.name}_å®Œæ•´è®°å½•.png`;
                a.href = canvas.toDataURL();
                a.click();

                // æ¸…ç†
                document.body.removeChild(clone);
            });
        }
    </script>
</body>

</html>
